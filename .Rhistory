proTeamId = numeric(0),
positionalRanking = numeric(0),
totalRanking = numeric(0),
totalRating = numeric(0),
status = numeric(0),
onTeamId = numeric(0)
)
# Get all players
url = paste0(base, year, mid, leagueID, player_tail)
# 1
Playersget = GET (
url,
config = httr::config(cookie = cookie),
content_type_json(),
user_agent(user_agent),
httr::add_headers(
"Referer" = glue("https://fantasy.espn.com/football/players/add?leagueId={leagueID}"),
"X-Fantasy-Filter" = x_fantasy_filter[1],
"X-Fantasy-Platform" = "kona-PROD-b3dba77950fd9b6a22ba3b8228a699d8bb974072",
"X-Fantasy-Source" = "kona"
)
)
Playersget$status_code
ESPNPlayersRaw <- rawToChar(Playersget$content)
ESPNPlayersFromJSON <- jsonlite::fromJSON(ESPNPlayersRaw)
ESPNPlayersFromJSON$players$player$fullName %>% head()
players <- data.frame(
ESPNPlayersFromJSON$players$player$id,
ESPNPlayersFromJSON$players$player$injured,
ESPNPlayersFromJSON$players$player$firstName,
ESPNPlayersFromJSON$players$player$lastName,
ESPNPlayersFromJSON$players$player$ownership$percentChange,
ESPNPlayersFromJSON$players$player$ownership$percentOwned,
ESPNPlayersFromJSON$players$player$ownership$percentStarted,
ESPNPlayersFromJSON$players$player$proTeamId,
ESPNPlayersFromJSON$players$ratings$'0'$positionalRanking,
ESPNPlayersFromJSON$players$ratings$'0'$totalRanking,
ESPNPlayersFromJSON$players$ratings$'0'$totalRating,
ESPNPlayersFromJSON$players$status,
ESPNPlayersFromJSON$players$onTeamId
)
# 2
Playersget = GET (
url,
config = httr::config(cookie = cookie),
content_type_json(),
user_agent(user_agent),
httr::add_headers(
"Referer" = glue("https://fantasy.espn.com/football/players/add?leagueId={leagueID}"),
"X-Fantasy-Filter" = x_fantasy_filter[2],
"X-Fantasy-Platform" = "kona-PROD-b3dba77950fd9b6a22ba3b8228a699d8bb974072",
"X-Fantasy-Source" = "kona"
)
)
Playersget$status_code
ESPNPlayersRaw <- rawToChar(Playersget$content)
ESPNPlayersFromJSON <- jsonlite::fromJSON(ESPNPlayersRaw)
ESPNPlayersFromJSON$players$player$fullName %>% head()
players <- rbind(players, data.frame(
ESPNPlayersFromJSON$players$player$id,
ESPNPlayersFromJSON$players$player$injured,
ESPNPlayersFromJSON$players$player$firstName,
ESPNPlayersFromJSON$players$player$lastName,
ESPNPlayersFromJSON$players$player$ownership$percentChange,
ESPNPlayersFromJSON$players$player$ownership$percentOwned,
ESPNPlayersFromJSON$players$player$ownership$percentStarted,
ESPNPlayersFromJSON$players$player$proTeamId,
ESPNPlayersFromJSON$players$ratings$'0'$positionalRanking,
ESPNPlayersFromJSON$players$ratings$'0'$totalRanking,
ESPNPlayersFromJSON$players$ratings$'0'$totalRating,
ESPNPlayersFromJSON$players$status,
ESPNPlayersFromJSON$players$onTeamId
))
# 3
Playersget = GET (
url,
config = httr::config(cookie = cookie),
content_type_json(),
user_agent(user_agent),
httr::add_headers(
"Referer" = glue("https://fantasy.espn.com/football/players/add?leagueId={leagueID}"),
"X-Fantasy-Filter" = x_fantasy_filter[3],
"X-Fantasy-Platform" = "kona-PROD-b3dba77950fd9b6a22ba3b8228a699d8bb974072",
"X-Fantasy-Source" = "kona"
)
)
Playersget$status_code
ESPNPlayersRaw <- rawToChar(Playersget$content)
ESPNPlayersFromJSON <- jsonlite::fromJSON(ESPNPlayersRaw)
ESPNPlayersFromJSON$players$player$fullName %>% head()
players <- rbind(players, data.frame(
ESPNPlayersFromJSON$players$player$id,
ESPNPlayersFromJSON$players$player$injured,
ESPNPlayersFromJSON$players$player$firstName,
ESPNPlayersFromJSON$players$player$lastName,
ESPNPlayersFromJSON$players$player$ownership$percentChange,
ESPNPlayersFromJSON$players$player$ownership$percentOwned,
ESPNPlayersFromJSON$players$player$ownership$percentStarted,
ESPNPlayersFromJSON$players$player$proTeamId,
ESPNPlayersFromJSON$players$ratings$'0'$positionalRanking,
ESPNPlayersFromJSON$players$ratings$'0'$totalRanking,
ESPNPlayersFromJSON$players$ratings$'0'$totalRating,
ESPNPlayersFromJSON$players$status,
ESPNPlayersFromJSON$players$onTeamId
))
# 4
Playersget = GET (
url,
config = httr::config(cookie = cookie),
content_type_json(),
user_agent(user_agent),
httr::add_headers(
"Referer" = glue("https://fantasy.espn.com/football/players/add?leagueId={leagueID}"),
"X-Fantasy-Filter" = x_fantasy_filter[4],
"X-Fantasy-Platform" = "kona-PROD-b3dba77950fd9b6a22ba3b8228a699d8bb974072",
"X-Fantasy-Source" = "kona"
)
)
Playersget$status_code
ESPNPlayersRaw <- rawToChar(Playersget$content)
ESPNPlayersFromJSON <- jsonlite::fromJSON(ESPNPlayersRaw)
ESPNPlayersFromJSON$players$player$fullName %>% head()
players <- rbind(players, data.frame(
ESPNPlayersFromJSON$players$player$id,
ESPNPlayersFromJSON$players$player$injured,
ESPNPlayersFromJSON$players$player$firstName,
ESPNPlayersFromJSON$players$player$lastName,
ESPNPlayersFromJSON$players$player$ownership$percentChange,
ESPNPlayersFromJSON$players$player$ownership$percentOwned,
ESPNPlayersFromJSON$players$player$ownership$percentStarted,
ESPNPlayersFromJSON$players$player$proTeamId,
ESPNPlayersFromJSON$players$ratings$'0'$positionalRanking,
ESPNPlayersFromJSON$players$ratings$'0'$totalRanking,
ESPNPlayersFromJSON$players$ratings$'0'$totalRating,
ESPNPlayersFromJSON$players$status,
ESPNPlayersFromJSON$players$onTeamId
))
colnames(players) <- players_columns
View(players)
distinct(players)
players <- distinct(players)
View(players)
# Create dataframe matching ESPN team IDs
team_abbr <- fantasy_roster$team.abbr %>% unique()
fantasy_roster$team.abbr %>% unique()
team_abbr[12]
team_abbr[18]
# Create dataframe matching ESPN team IDs
team_abbr <- fantasy_roster$team.abbr %>% unique()
team_id <-
c(22, 1, 33, 2, 29, 3, 4, 5, 6, 7, 8, 9, 34, 11, 30, 12, 14, 13, 15, 16, 17, 18, 19, 20, 21, 23, 26, 25, 27, 10, 28)
data.frame(team_abbr, team_id)
c(22, 1, 33, 2, 29, 3, 4, 5, 6, 7, 8, 9, 34, 11, 30, 12, 14, 13, 15, 16, 17, 18, 19, 20, 21, 23, 26, 25, 27, 10, 28) %>% length
team_abbr[1]
team_abbr[1] team_id[1]
team_abbr[1]
team_id[1]
team_abbr[2]
team_id[2]
team_abbr[3]]
team_id[3]
team_abbr[3]
team_id[3]
team_abbr[4]
team_id[4]
team_abbr[15]
team_id[15]
team_abbr[18]
team_id[18]
team_abbr <- fantasy_roster$team.abbr %>% unique()
team_id <-
c(22, 1, 33, 2, 29, 3, 4, 5, 6, 7, 8, 9, 34, 11, 30, 12, 14, 24, 13, 15, 16, 17, 18, 19, 20, 21, 23, 26, 25, 27, 10, 28)
data.frame(team_abbr, team_id)
espn_team_ids <- data.frame(team_abbr, team_id)
match(5, espn_team_ids)
match(5, espn_team_ids$team_abbr)
match(5, espn_team_ids$team_id)
espn_team_ids %>%
filter(team_abbr == 3) %>%
select(team_abbr)
espn_team_ids %>%
filter(team_id == 3) %>%
select(team_abbr)
pro_team_id_to_name <- function(x) {
y <- espn_team_ids %>%
filter(team_id == x) %>%
select(team_abbr)
return(y[1])
}
pbp_df %>% summarise(mean(epa))
pbp_df %>% summarise(epa)
pbp_df %>% summarise(epa) %>% mean()
pbp_df %>% summarise(epa)
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
add_xyac_dist %>%
select(season = season.x, game_id, play_id, posteam = posteam.x, receiver, passer_player_id, passer_id, yardline_100 = yardline_100.x, air_yards = air_yards.x, actual_yards_gained = yards_gained, complete_pass, cp, yac_prob = prob, gain)
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
add_xyac_dist %>%
select(season = season.x, game_id, play_id, posteam = posteam.x, passer_player_name, passer_player_id, passer_id, yardline_100 = yardline_100.x, air_yards = air_yards.x, actual_yards_gained = yards_gained, complete_pass, cp, yac_prob = prob, gain)
pbp_df$air_yards
pbp_df$cpoe
pbp_df$cp
pbp_df$cpoe
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
add_xyac_dist %>%
select(season = season.x, game_id, play_id, posteam = posteam.x, receiver, receiver_player_id, receiver_id, yardline_100 = yardline_100.x, air_yards = air_yards.x, actual_yards_gained = yards_gained, complete_pass, cp, cpoe, yac_prob = prob, gain) %>%
mutate(
gain = ifelse(yardline_100==air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100==air_yards, 1, yac_prob),
PPR_points = 1 + gain/10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain/10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained==gain & complete_pass==1, 1, 0),
actual_PPR_points = ifelse(actual_outcome==1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome==1, half_PPR_points, 0),
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
)
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
add_xyac_dist %>%
select(season = season.x, game_id, play_id, posteam = posteam.x, receiver, receiver_player_id, receiver_id, yardline_100 = yardline_100.x, air_yards = air_yards.x, actual_yards_gained = yards_gained, complete_pass, cp, cpoe, yac_prob = prob, gain) %>%
mutate(
gain = ifelse(yardline_100==air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100==air_yards, 1, yac_prob),
PPR_points = 1 + gain/10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain/10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained==gain & complete_pass==1, 1, 0),
actual_PPR_points = ifelse(actual_outcome==1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome==1, half_PPR_points, 0),
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
) %>% select(cayoe)
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
add_xyac_dist %>%
select(season = season.x, game_id, play_id, posteam = posteam.x, receiver, receiver_player_id, receiver_id, yardline_100 = yardline_100.x, air_yards = air_yards.x, actual_yards_gained = yards_gained, complete_pass, cp, cpoe, yac_prob = prob, gain) %>%
mutate(
gain = ifelse(yardline_100==air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100==air_yards, 1, yac_prob),
PPR_points = 1 + gain/10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain/10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained==gain & complete_pass==1, 1, 0),
actual_PPR_points = ifelse(actual_outcome==1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome==1, half_PPR_points, 0),
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
) %>% select(cayoe) %>% tail()
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
add_xyac_dist %>%
select(season = season.x, game_id, play_id, posteam = posteam.x, receiver, receiver_player_id, receiver_id, yardline_100 = yardline_100.x, air_yards = air_yards.x, actual_yards_gained = yards_gained, complete_pass, cp, cpoe, yac_prob = prob, gain) %>%
mutate(
gain = ifelse(yardline_100==air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100==air_yards, 1, yac_prob),
PPR_points = 1 + gain/10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain/10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained==gain & complete_pass==1, 1, 0),
actual_PPR_points = ifelse(actual_outcome==1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome==1, half_PPR_points, 0),
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
) %>% view()
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
select(season = season.x, game_id, play_id, posteam = posteam.x, passer, passer_player_id, passer_id, receiver, receiver_player_id, receiver_id, yardline_100 = yardline_100.x, air_yards = air_yards.x, actual_yards_gained = yards_gained, complete_pass, cp, cpoe, yac_prob = prob, gain) %>%
mutate(
gain = ifelse(yardline_100==air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100==air_yards, 1, yac_prob),
PPR_points = 1 + gain/10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain/10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained==gain & complete_pass==1, 1, 0),
actual_PPR_points = ifelse(actual_outcome==1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome==1, half_PPR_points, 0),
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
)
select(season, game_id, play_id, posteam, passer, passer_player_id, passer_id, receiver, receiver_player_id, receiver_id, yardline_100 = yardline_100.x, air_yards = air_yards.x, actual_yards_gained = yards_gained, complete_pass, cp, cpoe, yac_prob = prob, gain) %>%
mutate(
gain = ifelse(yardline_100==air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100==air_yards, 1, yac_prob),
PPR_points = 1 + gain/10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain/10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained==gain & complete_pass==1, 1, 0),
actual_PPR_points = ifelse(actual_outcome==1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome==1, half_PPR_points, 0),
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
)
select(season, game_id, play_id, posteam, passer, passer_player_id, passer_id, receiver, receiver_player_id, receiver_id, yardline_100, air_yards, actual_yards_gained = yards_gained, complete_pass, cp, cpoe, yac_prob = prob, gain) %>%
mutate(
gain = ifelse(yardline_100==air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100==air_yards, 1, yac_prob),
PPR_points = 1 + gain/10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain/10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained==gain & complete_pass==1, 1, 0),
actual_PPR_points = ifelse(actual_outcome==1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome==1, half_PPR_points, 0),
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
)
select(season, game_id, play_id, posteam, passer, passer_player_id, passer_id, receiver, receiver_player_id, receiver_id, yardline_100, air_yards, actual_yards_gained = yards_gained, complete_pass, cp, cpoe, yac_prob = prob, gain) %>%
mutate(
gain = ifelse(yardline_100==air_yards, yardline_100, gain),
PPR_points = 1 + gain/10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain/10 + ifelse(gain == yardline_100, 6, 0),
actual_outcome = ifelse(actual_yards_gained==gain & complete_pass==1, 1, 0),
actual_PPR_points = ifelse(actual_outcome==1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome==1, half_PPR_points, 0),
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
)
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
select(season, game_id, play_id, posteam, passer, passer_player_id, passer_id, receiver, receiver_player_id, receiver_id, yardline_100, air_yards, actual_yards_gained = yards_gained, complete_pass, cp, cpoe, yac_prob = prob, gain) %>%
mutate(
gain = ifelse(yardline_100==air_yards, yardline_100, gain),
PPR_points = 1 + gain/10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain/10 + ifelse(gain == yardline_100, 6, 0),
actual_outcome = ifelse(actual_yards_gained==gain & complete_pass==1, 1, 0),
actual_PPR_points = ifelse(actual_outcome==1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome==1, half_PPR_points, 0),
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
)
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
select(season, game_id, play_id, posteam, passer, passer_player_id, passer_id, receiver, receiver_player_id, receiver_id, yardline_100, air_yards, actual_yards_gained = yards_gained, complete_pass, cp, cpoe, gain) %>%
mutate(
gain = ifelse(yardline_100==air_yards, yardline_100, gain),
PPR_points = 1 + gain/10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain/10 + ifelse(gain == yardline_100, 6, 0),
actual_outcome = ifelse(actual_yards_gained==gain & complete_pass==1, 1, 0),
actual_PPR_points = ifelse(actual_outcome==1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome==1, half_PPR_points, 0),
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
)
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
select(season, game_id, play_id, posteam, passer, passer_player_id, passer_id, receiver, receiver_player_id, receiver_id, yardline_100, air_yards, actual_yards_gained = yards_gained, complete_pass, cp, cpoe) %>%
mutate(
gain = ifelse(yardline_100==air_yards, yardline_100, gain),
PPR_points = 1 + gain/10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain/10 + ifelse(gain == yardline_100, 6, 0),
actual_outcome = ifelse(actual_yards_gained==gain & complete_pass==1, 1, 0),
actual_PPR_points = ifelse(actual_outcome==1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome==1, half_PPR_points, 0),
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
)
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
select(season, game_id, play_id, posteam, passer, passer_player_id, passer_id, receiver, receiver_player_id, receiver_id, yardline_100, air_yards, actual_yards_gained = yards_gained, complete_pass, cp, cpoe) %>%
mutate(
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
)
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
select(season, game_id, play_id, posteam, passer, passer_player_id, passer_id, receiver, receiver_player_id, receiver_id, yardline_100, air_yards, actual_yards_gained = yards_gained, complete_pass, cp, cpoe) %>%
mutate(
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
) %>% view()
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
select(season, game_id, play_id, posteam, passer, passer_player_id, passer_id, receiver, receiver_player_id, receiver_id, yardline_100, air_yards, actual_yards_gained = yards_gained, complete_pass, cp, cpoe) %>%
mutate(
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
) %>%
group_by(game_id, passer)
pbp_df %>%
filter(pass_attempt==1 & season_type=='REG' & two_point_attempt==0 & !is.na(receiver_id)) %>%
select(season, game_id, play_id, posteam, passer, passer_player_id, passer_id, receiver, receiver_player_id, receiver_id, yardline_100, air_yards, actual_yards_gained = yards_gained, complete_pass, cp, cpoe) %>%
mutate(
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
) %>%
group_by(game_id, passer) %>%
mutate(game_played = ifelse(row_number()==1,1,0)) %>%
ungroup %>%
group_by(game_id, play_id, passer) %>%
mutate(target = ifelse(row_number()==1,1,0)) %>%
ungroup %>%
group_by(posteam, passer)
pbp_df$pass_attempt
pbp_df $complete_pass
cayoe <- pbp_df %>%
filter(pass_attempt == 1 &
season_type == 'REG' &
two_point_attempt == 0 & !is.na(receiver_id)) %>%
add_xyac_dist %>%
select(
season = season.x,
game_id,
play_id,
posteam = posteam.x,
passer,
passer_player_id,
passer_id,
receiver,
receiver_player_id,
receiver_id,
yardline_100 = yardline_100.x,
air_yards = air_yards.x,
actual_yards_gained = yards_gained,
complete_pass,
cp,
cpoe,
yac_prob = prob,
gain,
pass_attempt
) %>%
mutate(
gain = ifelse(yardline_100 == air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100 == air_yards, 1, yac_prob),
PPR_points = 1 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained == gain &
complete_pass == 1, 1, 0),
actual_PPR_points = ifelse(actual_outcome == 1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome == 1, half_PPR_points, 0),
target = 0,
game_played = 0,
cayoe = cpoe * air_yards
) %>%
group_by(game_id, passer) %>%
mutate(game_played = ifelse(row_number() == 1, 1, 0)) %>%
ungroup %>%
group_by(game_id, play_id, passer) %>%
mutate(target = ifelse(row_number() == 1, 1, 0)) %>%
ungroup %>%
group_by(posteam, passer) %>%
summarize(
games = sum(game_played, na.rm = T),
pass_attempts = sum(pass_attempt, na.rm = T),
completions = sum(complete_pass, na.rm = T),
yards = sum(ifelse(actual_outcome == 1, gain, 0), na.rm = T),
td = sum(ifelse(gain == yardline_100, actual_outcome, 0), na.rm = T),
PPR_pts = sum(actual_PPR_points, na.rm = T),
half_PPR_pts = sum(actual_half_PPR_points, na.rm = T),
exp_catches = sum(ifelse(target == 1, cp, NA), na.rm = T),
exp_yards = sum(exp_yards, na.rm = T),
exp_td = sum(ifelse(gain == yardline_100, catch_run_prob, 0), na.rm = T),
exp_PPR_pts = sum(exp_PPR_points, na.rm = T),
exp_half_PPR_pts = sum(exp_half_PPR_points, na.rm = T),
sum_cayoe = sum(cayoe, na.rm = T),
) %>%
mutate(
half_ppr_pts_diff = half_PPR_pts - exp_half_PPR_pts,
ppr_pts_diff = PPR_pts - exp_PPR_pts,
cayoe_a = sum_cayoe / pass_attempts
) %>%
ungroup
View(cayoe)
View(cayoe)
pbp_df %>%
filter(pass_attempt == 1 &
season_type == 'REG' &
two_point_attempt == 0 & !is.na(receiver_id & complete_pass == 1))
pbp_df$complete_pass
