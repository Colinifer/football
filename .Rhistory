half_ppr_pts_diff = half_PPR_pts - exp_half_PPR_pts,
ppr_pts_diff = PPR_pts - exp_PPR_pts,
cayoe_a = sum_cayoe / pass_attempts
) %>%
ungroup
# Completed Air Yards Over Expected
cayoe <- pbp_df %>%
filter(pass_attempt == 1 &
season_type == 'REG' &
two_point_attempt == 0 & !is.na(receiver_id) &
# wp > .2 &
# wp < .8 &
air_yards > 0) %>%
add_xyac_dist_old %>%
select(
season = season.x,
game_id,
play_id,
posteam = posteam.x,
passer,
passer_player_id,
passer_id,
receiver,
receiver_player_id,
receiver_id,
yardline_100 = yardline_100.x,
air_yards = air_yards.x,
actual_yards_gained = yards_gained,
complete_pass,
cp,+
cpoe,
yac_prob = prob,
gain,
pass_attempt
) %>%
mutate(
gain = ifelse(yardline_100 == air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100 == air_yards, 1, yac_prob),
PPR_points = 1 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained == gain &
complete_pass == 1, 1, 0),
actual_PPR_points = ifelse(actual_outcome == 1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome == 1, half_PPR_points, 0),
# completion = 0,
game_played = 0,
cayoe = cpoe * air_yards,
sum_cayoe = 0
) %>%
group_by(game_id, passer_player_id) %>%
mutate(game_played = ifelse(row_number() == 1, 1, 0)) %>%
ungroup %>%
# group_by(game_id, play_id, passer) %>%
# mutate(completion = ifelse(row_number() == 1, 1, 0)) %>%
# ungroup %>%
group_by(posteam, passer) %>%
# filter()
summarize(
games = sum(game_played, na.rm = T),
pass_attempts = sum(pass_attempt, na.rm = T),
completions = sum(actual_outcome, na.rm = T),
yards = sum(ifelse(actual_outcome == 1, gain, 0), na.rm = T),
td = sum(ifelse(gain == yardline_100, actual_outcome, 0), na.rm = T),
PPR_pts = sum(actual_PPR_points, na.rm = T),
half_PPR_pts = sum(actual_half_PPR_points, na.rm = T),
exp_completions = sum(ifelse(completion == 1, cp, NA), na.rm = T),
exp_yards = sum(exp_yards, na.rm = T),
exp_td = sum(ifelse(gain == yardline_100, catch_run_prob, 0), na.rm = T),
exp_PPR_pts = sum(exp_PPR_points, na.rm = T),
exp_half_PPR_pts = sum(exp_half_PPR_points, na.rm = T),
sum_cayoe = sum(cayoe, na.rm = T),
) %>%
mutate(
half_ppr_pts_diff = half_PPR_pts - exp_half_PPR_pts,
ppr_pts_diff = PPR_pts - exp_PPR_pts,
cayoe_a = sum_cayoe / pass_attempts
) %>%
ungroup
# Completed Air Yards Over Expected
cayoe <- pbp_df %>%
filter(pass_attempt == 1 &
season_type == 'REG' &
two_point_attempt == 0 & !is.na(receiver_id) &
# wp > .2 &
# wp < .8 &
air_yards > 0) %>%
add_xyac_dist_old %>%
select(
season = season.x,
game_id,
play_id,
posteam = posteam.x,
passer,
passer_player_id,
passer_id,
receiver,
receiver_player_id,
receiver_id,
yardline_100 = yardline_100.x,
air_yards = air_yards.x,
actual_yards_gained = yards_gained,
complete_pass,
cp,
cpoe,
yac_prob = prob,
gain,
pass_attempt
) %>%
mutate(
gain = ifelse(yardline_100 == air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100 == air_yards, 1, yac_prob),
PPR_points = 1 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained == gain &
complete_pass == 1, 1, 0),
actual_PPR_points = ifelse(actual_outcome == 1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome == 1, half_PPR_points, 0),
# completion = 0,
game_played = 0,
cayoe = cpoe * air_yards,
sum_cayoe = 0
) %>%
group_by(game_id, passer_player_id) %>%
mutate(game_played = ifelse(row_number() == 1, 1, 0)) %>%
ungroup %>%
# group_by(game_id, play_id, passer) %>%
# mutate(completion = ifelse(row_number() == 1, 1, 0)) %>%
# ungroup %>%
group_by(posteam, passer) %>%
# filter()
summarize(
games = sum(game_played, na.rm = T),
pass_attempts = sum(pass_attempt, na.rm = T),
completions = sum(actual_outcome, na.rm = T),
yards = sum(ifelse(actual_outcome == 1, gain, 0), na.rm = T),
td = sum(ifelse(gain == yardline_100, actual_outcome, 0), na.rm = T),
PPR_pts = sum(actual_PPR_points, na.rm = T),
half_PPR_pts = sum(actual_half_PPR_points, na.rm = T),
exp_completions = sum(ifelse(completion == 1, cp, NA), na.rm = T),
exp_yards = sum(exp_yards, na.rm = T),
exp_td = sum(ifelse(gain == yardline_100, catch_run_prob, 0), na.rm = T),
exp_PPR_pts = sum(exp_PPR_points, na.rm = T),
exp_half_PPR_pts = sum(exp_half_PPR_points, na.rm = T),
sum_cayoe = sum(cayoe, na.rm = T),
) %>%
mutate(
half_ppr_pts_diff = half_PPR_pts - exp_half_PPR_pts,
ppr_pts_diff = PPR_pts - exp_PPR_pts,
cayoe_a = sum_cayoe / pass_attempts
) %>%
ungroup
# Completed Air Yards Over Expected
cayoe <- pbp_df %>%
filter(pass_attempt == 1 &
season_type == 'REG' &
two_point_attempt == 0 & !is.na(receiver_id) &
# wp > .2 &
# wp < .8 &
air_yards > 0) %>%
add_xyac_dist_old %>%
select(
season = season.x,
game_id,
play_id,
posteam = posteam.x,
passer,
passer_player_id,
passer_id,
receiver,
receiver_player_id,
receiver_id,
yardline_100 = yardline_100.x,
air_yards = air_yards.x,
actual_yards_gained = yards_gained,
complete_pass,
cp,
cpoe,
yac_prob = prob,
gain,
pass_attempt
) %>%
mutate(
gain = ifelse(yardline_100 == air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100 == air_yards, 1, yac_prob),
PPR_points = 1 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained == gain &
complete_pass == 1, 1, 0),
actual_PPR_points = ifelse(actual_outcome == 1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome == 1, half_PPR_points, 0),
completion = 0,
game_played = 0,
cayoe = cpoe * air_yards,
sum_cayoe = 0
) %>%
group_by(game_id, passer_player_id) %>%
mutate(game_played = ifelse(row_number() == 1, 1, 0)) %>%
ungroup %>%
group_by(game_id, play_id, passer) %>%
mutate(completion = ifelse(row_number() == 1, 1, 0)) %>%
ungroup %>%
group_by(posteam, passer) %>%
# filter()
summarize(
games = sum(game_played, na.rm = T),
pass_attempts = sum(pass_attempt, na.rm = T),
completions = sum(completion, na.rm = T),
yards = sum(ifelse(actual_outcome == 1, gain, 0), na.rm = T),
td = sum(ifelse(gain == yardline_100, actual_outcome, 0), na.rm = T),
PPR_pts = sum(actual_PPR_points, na.rm = T),
half_PPR_pts = sum(actual_half_PPR_points, na.rm = T),
exp_completions = sum(ifelse(completion == 1, cp, NA), na.rm = T),
exp_yards = sum(exp_yards, na.rm = T),
exp_td = sum(ifelse(gain == yardline_100, catch_run_prob, 0), na.rm = T),
exp_PPR_pts = sum(exp_PPR_points, na.rm = T),
exp_half_PPR_pts = sum(exp_half_PPR_points, na.rm = T),
sum_cayoe = sum(cayoe, na.rm = T),
) %>%
mutate(
half_ppr_pts_diff = half_PPR_pts - exp_half_PPR_pts,
ppr_pts_diff = PPR_pts - exp_PPR_pts,
cayoe_a = sum_cayoe / pass_attempts
) %>%
ungroup
View(cayoe)
# Completed Air Yards Over Expected
cayoe <- pbp_df %>%
filter(pass_attempt == 1 &
season_type == 'REG' &
two_point_attempt == 0 & !is.na(receiver_id) &
# wp > .2 &
# wp < .8 &
air_yards > 0) %>%
add_xyac_dist_old %>%
select(
season = season.x,
game_id,
play_id,
posteam = posteam.x,
passer,
passer_player_id,
passer_id,
receiver,
receiver_player_id,
receiver_id,
yardline_100 = yardline_100.x,
air_yards = air_yards.x,
actual_yards_gained = yards_gained,
complete_pass,
cp,
cpoe,
yac_prob = prob,
gain,
pass_attempt
) %>%
mutate(
gain = ifelse(yardline_100 == air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100 == air_yards, 1, yac_prob),
PPR_points = 1 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained == gain &
complete_pass == 1, 1, 0),
actual_PPR_points = ifelse(actual_outcome == 1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome == 1, half_PPR_points, 0),
completion = 0,
attempts = 0,
game_played = 0,
cayoe = cpoe * air_yards,
sum_cayoe = 0
) %>%
group_by(game_id, passer_player_id) %>%
mutate(game_played = ifelse(row_number() == 1, 1, 0)) %>%
ungroup %>%
group_by(game_id, play_id, passer) %>%
mutate(completion = ifelse(row_number() == 1, 1, 0),
attempts = n()) %>%
ungroup %>%
group_by(posteam, passer) %>%
# filter()
summarize(
games = sum(game_played, na.rm = T),
pass_attempts = sum(attempts, na.rm = T),
completions = sum(completion, na.rm = T),
yards = sum(ifelse(actual_outcome == 1, gain, 0), na.rm = T),
td = sum(ifelse(gain == yardline_100, actual_outcome, 0), na.rm = T),
PPR_pts = sum(actual_PPR_points, na.rm = T),
half_PPR_pts = sum(actual_half_PPR_points, na.rm = T),
exp_completions = sum(ifelse(completion == 1, cp, NA), na.rm = T),
exp_yards = sum(exp_yards, na.rm = T),
exp_td = sum(ifelse(gain == yardline_100, catch_run_prob, 0), na.rm = T),
exp_PPR_pts = sum(exp_PPR_points, na.rm = T),
exp_half_PPR_pts = sum(exp_half_PPR_points, na.rm = T),
sum_cayoe = sum(cayoe, na.rm = T),
) %>%
mutate(
half_ppr_pts_diff = half_PPR_pts - exp_half_PPR_pts,
ppr_pts_diff = PPR_pts - exp_PPR_pts,
cayoe_a = sum_cayoe / pass_attempts
) %>%
ungroup
# Completed Air Yards Over Expected
cayoe_xyac <- pbp_df %>%
filter(pass_attempt == 1 &
season_type == 'REG' &
two_point_attempt == 0 & !is.na(receiver_id) &
# wp > .2 &
# wp < .8 &
air_yards > 0) %>%
add_xyac_dist_old
cayoe_xyac %>%
select(
season = season.x,
game_id,
play_id,
posteam = posteam.x,
passer,
passer_player_id,
passer_id,
receiver,
receiver_player_id,
receiver_id,
yardline_100 = yardline_100.x,
air_yards = air_yards.x,
actual_yards_gained = yards_gained,
complete_pass,
cp,
cpoe,
yac_prob = prob,
gain,
pass_attempt
) %>%
mutate(
gain = ifelse(yardline_100 == air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100 == air_yards, 1, yac_prob),
PPR_points = 1 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained == gain &
complete_pass == 1, 1, 0),
actual_PPR_points = ifelse(actual_outcome == 1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome == 1, half_PPR_points, 0),
completion = 0,
attempts = 0,
game_played = 0,
cayoe = cpoe * air_yards,
sum_cayoe = 0
) %>%
group_by(game_id, passer_player_id) %>%
mutate(game_played = ifelse(row_number() == 1, 1, 0)) %>%
ungroup %>%
group_by(game_id, play_id, passer) %>%
mutate(completion = ifelse(row_number() == 1, 1, 0),
attempts = row_number()) %>%
ungroup %>%
group_by(posteam, passer) %>%
# filter()
summarize(
games = sum(game_played, na.rm = T),
pass_attempts = sum(attempts, na.rm = T),
completions = sum(completion, na.rm = T),
yards = sum(ifelse(actual_outcome == 1, gain, 0), na.rm = T),
td = sum(ifelse(gain == yardline_100, actual_outcome, 0), na.rm = T),
PPR_pts = sum(actual_PPR_points, na.rm = T),
half_PPR_pts = sum(actual_half_PPR_points, na.rm = T),
exp_completions = sum(ifelse(completion == 1, cp, NA), na.rm = T),
exp_yards = sum(exp_yards, na.rm = T),
exp_td = sum(ifelse(gain == yardline_100, catch_run_prob, 0), na.rm = T),
exp_PPR_pts = sum(exp_PPR_points, na.rm = T),
exp_half_PPR_pts = sum(exp_half_PPR_points, na.rm = T),
sum_cayoe = sum(cayoe, na.rm = T),
) %>%
mutate(
half_ppr_pts_diff = half_PPR_pts - exp_half_PPR_pts,
ppr_pts_diff = PPR_pts - exp_PPR_pts,
cayoe_a = sum_cayoe / pass_attempts
) %>%
ungroup
cayoe_xyac %>%
select(
season = season.x,
game_id,
play_id,
posteam = posteam.x,
passer,
passer_player_id,
passer_id,
receiver,
receiver_player_id,
receiver_id,
yardline_100 = yardline_100.x,
air_yards = air_yards.x,
actual_yards_gained = yards_gained,
complete_pass,
cp,
cpoe,
yac_prob = prob,
gain,
pass_attempt
) %>%
mutate(
gain = ifelse(yardline_100 == air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100 == air_yards, 1, yac_prob),
PPR_points = 1 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained == gain &
complete_pass == 1, 1, 0),
actual_PPR_points = ifelse(actual_outcome == 1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome == 1, half_PPR_points, 0),
completion = 0,
attempts = 0,
game_played = 0,
cayoe = cpoe * air_yards,
sum_cayoe = 0
) %>%
group_by(game_id, passer_player_id) %>%
mutate(game_played = ifelse(row_number() == 1, 1, 0)) %>%
ungroup %>%
group_by(game_id, play_id, passer)
?row_number
cayoe_xyac %>%
select(
season = season.x,
game_id,
play_id,
posteam = posteam.x,
passer,
passer_player_id,
passer_id,
receiver,
receiver_player_id,
receiver_id,
yardline_100 = yardline_100.x,
air_yards = air_yards.x,
actual_yards_gained = yards_gained,
complete_pass,
cp,
cpoe,
yac_prob = prob,
gain,
pass_attempt
) %>%
mutate(
gain = ifelse(yardline_100 == air_yards, yardline_100, gain),
yac_prob = ifelse(yardline_100 == air_yards, 1, yac_prob),
PPR_points = 1 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
half_PPR_points = .5 + gain / 10 + ifelse(gain == yardline_100, 6, 0),
catch_run_prob = cp * yac_prob,
exp_PPR_points = PPR_points * catch_run_prob,
exp_half_PPR_points = half_PPR_points * catch_run_prob,
exp_yards = gain * catch_run_prob,
actual_outcome = ifelse(actual_yards_gained == gain &
complete_pass == 1, 1, 0),
actual_PPR_points = ifelse(actual_outcome == 1, PPR_points, 0),
actual_half_PPR_points = ifelse(actual_outcome == 1, half_PPR_points, 0),
completion = 0,
attempts = 0,
game_played = 0,
cayoe = cpoe * air_yards,
sum_cayoe = 0
) %>%
group_by(game_id, passer_player_id) %>%
mutate(game_played = ifelse(row_number() == 1, 1, 0)) %>%
ungroup %>%
group_by(game_id, play_id, passer) %>%
mutate(completion = ifelse(row_number() == 1, 1, 0)) %>%
ungroup %>%
group_by(posteam, passer) %>%
# filter()
summarize(
games = sum(game_played, na.rm = T),
pass_attempts = sum(pass_attempt, na.rm = T),
completions = sum(completion, na.rm = T),
yards = sum(ifelse(actual_outcome == 1, gain, 0), na.rm = T),
td = sum(ifelse(gain == yardline_100, actual_outcome, 0), na.rm = T),
PPR_pts = sum(actual_PPR_points, na.rm = T),
half_PPR_pts = sum(actual_half_PPR_points, na.rm = T),
exp_completions = sum(ifelse(completion == 1, cp, NA), na.rm = T),
exp_yards = sum(exp_yards, na.rm = T),
exp_td = sum(ifelse(gain == yardline_100, catch_run_prob, 0), na.rm = T),
exp_PPR_pts = sum(exp_PPR_points, na.rm = T),
exp_half_PPR_pts = sum(exp_half_PPR_points, na.rm = T),
sum_cayoe = sum(cayoe, na.rm = T),
) %>%
mutate(
half_ppr_pts_diff = half_PPR_pts - exp_half_PPR_pts,
ppr_pts_diff = PPR_pts - exp_PPR_pts,
cayoe_a = sum_cayoe / pass_attempts
) %>%
ungroup
