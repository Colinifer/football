qb_min <- 320 #min # of qb plays
# Adjust EPA --------------------------------------------------------------
# https://www.opensourcefootball.com/posts/2020-08-20-adjusting-epa-for-strenght-of-opponent/
epa_data <- pbp_df %>%
dplyr::filter(!is.na(epa), !is.na(ep), !is.na(posteam), play_type == "pass" | play_type == "run") %>%
dplyr::group_by(game_id, season, week, posteam, home_team) %>%
dplyr::summarise(
off_epa = mean(epa),
) %>%
dplyr::left_join(pbp_df %>%
filter(!is.na(epa), !is.na(ep), !is.na(posteam), play_type == "pass" | play_type == "run") %>%
dplyr::group_by(game_id, season, week, defteam, away_team) %>%
dplyr::summarise(def_epa = mean(epa)),
by = c("game_id", "posteam" = "defteam", "season", "week"),
all.x = TRUE
) %>%
dplyr::mutate(opponent = ifelse(posteam == home_team, away_team, home_team)) %>%
dplyr::select(game_id, season, week, home_team, away_team, posteam, opponent, off_epa, def_epa)
offense <- pbp_df %>%
filter(!is.na(epa) & !is.na(posteam)) %>%
group_by(posteam, season)%>%
summarize(
n_pass=sum(pass),
n_rush=sum(rush),
epa_per_pass=sum(epa*pass)/n_pass,
epa_per_rush=sum(epa*rush)/n_rush,
success_per_pass=sum(pass*epa>0)/n_pass,
success_per_rush=sum(rush*epa>0)/n_rush,
off_epa=mean(epa),
off_success=mean(success)
)
# Construct opponent dataset and lag the moving average of their last ten games.
opponent_data <- epa_data %>%
dplyr::select(-opponent) %>%
dplyr::rename(
opp_off_epa = off_epa,
opp_def_epa = def_epa
) %>%
dplyr::group_by(posteam) %>%
dplyr::arrange(season, week) %>%
dplyr::mutate(
opp_def_epa = pracma::movavg(opp_def_epa, n = as.integer(time_series), type = "s"),
opp_def_epa = dplyr::lag(opp_def_epa),
opp_off_epa = pracma::movavg(opp_off_epa, n = as.integer(time_series), type = "s"),
opp_off_epa = dplyr::lag(opp_off_epa)
)
# Merge opponent data back in with the weekly epa data
epa_data <- epa_data %>%
left_join(
opponent_data,
by = c("game_id", "season", "week", "home_team", "away_team", "opponent" = "posteam"),
all.x = TRUE
)
epa_data <- epa_data %>%
dplyr::left_join(epa_data %>%
dplyr::filter(posteam == home_team) %>%
dplyr::group_by(season, week) %>%
dplyr::summarise(
league_mean = mean(off_epa + def_epa)
) %>%
dplyr::ungroup() %>%
dplyr::group_by(season) %>%
dplyr::mutate(
league_mean = lag(pracma::movavg(league_mean, n = as.integer(time_series), type = "s"), ) # We lag because we need to know the league mean up to that point in the season
),
by = c("season", "week"),
all.x = TRUE
)
# Adjust EPA
epa_data <- epa_data %>%
dplyr::mutate(
off_adjustment_factor = ifelse(!is.na(league_mean), league_mean - opp_def_epa, 0),
def_adjustment_factor = ifelse(!is.na(league_mean), league_mean - opp_off_epa, 0),
adjusted_off_epa = off_epa + off_adjustment_factor,
adjusted_def_epa = def_epa + def_adjustment_factor,
)
chart_all <- epa_data %>%
filter(season == 2020) %>%
arrange(posteam) %>%
group_by(posteam) %>%
summarize(
adjusted_off_epa = mean(adjusted_off_epa),
adjusted_def_epa = mean(adjusted_def_epa)
) %>%
# filter(row_number() == n()) %>%
left_join(teams_colors_logos, by = c("posteam" = "team_abbr"))
chart_all %>%
ggplot(aes(x = adjusted_off_epa, y = adjusted_def_epa)) +
geom_image(aes(image = team_logo_espn), size = 0.05, asp = 16/9) +
geom_hline(yintercept = mean(chart_all$adjusted_off_epa), color = "red", linetype = "dashed") +
geom_vline(xintercept =  mean(chart_all$adjusted_def_epa), color = "red", linetype = "dashed") +
labs(x = "Adj. Offense EPA/play",
y = "Adj. Defense EPA/play",
# caption = "Data: @nflscrapR",
title = paste(year, "NFL adjusted team tiers through week", as.integer(time_series) + 1)) +
geom_abline(slope=slope, intercept=.4, alpha=.2) +
geom_abline(slope=slope, intercept=.3, alpha=.2) +
geom_abline(slope=slope, intercept=0, alpha=.2) +
geom_abline(slope=slope, intercept=.1, alpha=.2) +
geom_abline(slope=slope, intercept=.2, alpha=.2) +
geom_abline(slope=slope, intercept=-.1, alpha=.2) +
geom_abline(slope=slope, intercept=-.2, alpha=.2) +
geom_abline(slope=slope, intercept=-.3, alpha=.2) +
scale_y_reverse() +
theme_cw +
theme(
axis.title.y = element_text(angle = 90),
legend.position = c(0.99, 0.99),
legend.justification = c(1, 1) ,
plot.title = element_text(size = 16, hjust = 0.5),
#panel.grid.minor = element_blank()
)
source('plots/assets/plot_theme.R')
chart_all %>%
ggplot(aes(x = adjusted_off_epa, y = adjusted_def_epa)) +
geom_image(aes(image = team_logo_espn), size = 0.05, asp = 16/9) +
geom_hline(yintercept = mean(chart_all$adjusted_off_epa), color = "red", linetype = "dashed") +
geom_vline(xintercept =  mean(chart_all$adjusted_def_epa), color = "red", linetype = "dashed") +
labs(x = "Adj. Offense EPA/play",
y = "Adj. Defense EPA/play",
# caption = "Data: @nflscrapR",
title = paste(year, "NFL adjusted team tiers through week", as.integer(time_series) + 1)) +
geom_abline(slope=slope, intercept=.4, alpha=.2) +
geom_abline(slope=slope, intercept=.3, alpha=.2) +
geom_abline(slope=slope, intercept=0, alpha=.2) +
geom_abline(slope=slope, intercept=.1, alpha=.2) +
geom_abline(slope=slope, intercept=.2, alpha=.2) +
geom_abline(slope=slope, intercept=-.1, alpha=.2) +
geom_abline(slope=slope, intercept=-.2, alpha=.2) +
geom_abline(slope=slope, intercept=-.3, alpha=.2) +
scale_y_reverse() +
theme_cw +
theme(
axis.title.y = element_text(angle = 90),
legend.position = c(0.99, 0.99),
legend.justification = c(1, 1) ,
plot.title = element_text(size = 16, hjust = 0.5),
#panel.grid.minor = element_blank()
)
# source("fantasy_football/ff_init.R")
source('plots/scripts/team_tiers.R')
source('fantasy_football/xfantasy_points.R')
source('plots/scripts/qb_cayoe.R')
cayoe %>%
filter(pass_attempts > (summary(pass_attempts)[4]))
summary(cayoe$pass_attempts)[4])
summary(cayoe$pass_attempts)
cayoe %>% filter(posteam == "SF")
cayoe %>%
filter(pass_attempts > if_else(summary(pass_attempts)[4]>75, 75, (summary(pass_attempts)[4])))
cayoe %>%
filter(pass_attempts > ifelse(summary(pass_attempts)[4]>75, 75, (summary(pass_attempts)[4])))
ifelse(summary(pass_attempts)[4]>75, 75, (summary(pass_attempts)[4]))
ifelse(summary(cayoe$pass_attempts)[4]>75, 75, (summary(cayoe$pass_attempts)[4]))
summary(cayoe$pass_attempts)[4]>75
cayoe %>%
filter(pass_attempts > ifelse(summary(pass_attempts)[4]>75, 75, summary(pass_attempts)[4]))
View(cayoe)
cayoe_filtered <- cayoe %>%
filter(pass_attempts > ifelse(summary(pass_attempts)[4]>75, 75, summary(pass_attempts)[4]))
View(cayoe_filtered)
cayoe_filtered <- cayoe %>%
filter(pass_attempts > ifelse(summary(pass_attempts)[4]>=75, 75, summary(pass_attempts)[4]))
View(cayoe_filtered)
cayoe %>%
filter(pass_attempts > ifelse(summary(pass_attempts)[4]>=75, 75, summary(pass_attempts)[4]))
cayoe %>%
filter(pass_attempts > ifelse(summary(pass_attempts)[4]>=75, 75, summary(pass_attempts)[4])) %>% filter(posteam == "SF")
cayoe %>%
filter(pass_attempts >= ifelse(summary(pass_attempts)[4]>=75, 75, summary(pass_attempts)[4])) %>% filter(posteam == "SF")
cayoe_filtered <- cayoe %>%
filter(pass_attempts >= ifelse(summary(pass_attempts)[4]>75, 75, summary(pass_attempts)[4]))
View(cayoe_filtered)
source('plots/scripts/qb_cayoe.R')
cayoe_filtered$season
# xFP QB table
cayoe_filtered %>%
select(
games,
passer,
posteam,
pass_attempts,
completions,
yards,
td,
# PPR_pts,
exp_completions,
exp_yards,
exp_td,
# exp_PPR_pts,
# ppr_pts_diff,
sum_cayoe,
cayoe_a
) %>%
arrange(-cayoe_a) %>%
dplyr::slice(1:50) %>%
mutate(Rank = paste0('#',row_number())) %>%
gt() %>%
tab_header(title = paste('Completed Air Yards Over Expected (CAYOE),', cayoe_filtered$season[1]),
subtitle = paste('Through week', my_week, 'MNF', '|', 'Min.', ifelse(round(summary(cayoe_filtered$pass_attempts)[4]>75,75,round(summary(cayoe_filtered$pass_attempts)[4]),'pass attempts > 0 air yards')))) %>%
cols_move_to_start(columns = vars(Rank)) %>%
cols_label(
games = 'GP',
passer = '',
posteam = '',
pass_attempts = 'Pass Attempts',
completions = 'Comp.',
yards = 'Yds',
td = 'TD',
# PPR_pts = 'FP',
exp_completions = 'xComp.',
exp_yards = 'xYds',
exp_td = 'xTD',
# exp_PPR_pts = 'xFP',
# ppr_pts_diff = "Pts Diff.",
sum_cayoe = "Total CAYOE",
cayoe_a = "Avg CAYOE"
) %>%
fmt_number(columns = vars(sum_cayoe, cayoe_a), decimals = 2) %>%
fmt_number(columns = vars(exp_td), decimals = 1) %>%
fmt_number(columns = vars(yards, exp_yards, exp_completions), decimals = 0, sep_mark = ',') %>%
tab_style(style = cell_text(size = 'x-large', weight = 'bold'), locations = cells_title(groups = 'title')) %>%
tab_style(style = cell_text(align = 'center', size = 'medium'), locations = cells_body()) %>%
tab_style(style = cell_text(align = 'left'), locations = cells_body(vars(passer))) %>%
tab_style(
style = cell_borders(
sides = "left",
color = color_cw[5],
weight = px(3)
),
locations = list(
cells_body(
columns = c(4,8,11,12)
)
)
) %>%
tab_style(
style = cell_text(weight = "bold"),
locations = cells_body(
columns = vars(Rank, passer)
)
) %>%
tab_spanner(label = 'Actual', columns = vars(completions, yards, td)) %>%
tab_spanner(label = 'Expected', columns = vars(exp_completions, exp_yards, exp_td)) %>%
tab_source_note(source_note = 'Data: @nflfastR') %>%
data_color(
columns = vars(sum_cayoe),
colors = scales::col_numeric(palette = c(color_cw[2], color_cw[6]), domain = c(max(cayoe_filtered$sum_cayoe), min(cayoe_filtered$sum_cayoe))),
autocolor_text = FALSE
) %>%
data_color(
columns = vars(cayoe_a),
colors = scales::col_numeric(palette = c(color_cw[2], color_cw[6]), domain = c(max(cayoe_filtered$cayoe_a), min(cayoe_filtered$cayoe_a))),
autocolor_text = FALSE
) %>%
text_transform(
locations = cells_body(vars(posteam)),
fn = function(x) web_image(url = paste0('https://a.espncdn.com/i/teamlogos/nfl/500/',x,'.png'))
) %>%
cols_width(vars(posteam) ~ px(45)) %>%
tab_options(
table.font.color = color_cw[5],
data_row.padding = '2px',
row_group.padding = '3px',
column_labels.border.bottom.color = color_cw[5],
column_labels.border.bottom.width = 1.4,
column_labels.font.weight = "bold",
table_body.border.top.color = color_cw[5],
row_group.border.top.width = 1.5,
row_group.border.top.color = '#999999',
table_body.border.bottom.width = 0.7,
table_body.border.bottom.color = '#999999',
row_group.border.bottom.width = 1,
row_group.border.bottom.color = color_cw[5],
table.border.top.color = 'transparent',
table.background.color = color_cw[1],
table.border.bottom.color = 'transparent',
row.striping.background_color = color_cw[2],
row.striping.include_table_body = TRUE
) %>%
opt_table_font(
font = list(
google_font("Chivo"),
default_fonts()
)
) %>%
gtsave(filename = paste0("xFP_QB_", cayoe_filtered$season[1], ".png"), path = "plots/desktop")
# xFP QB table
cayoe_filtered %>%
select(
games,
passer,
posteam,
pass_attempts,
completions,
yards,
td,
# PPR_pts,
exp_completions,
exp_yards,
exp_td,
# exp_PPR_pts,
# ppr_pts_diff,
sum_cayoe,
cayoe_a
) %>%
arrange(-cayoe_a) %>%
dplyr::slice(1:50) %>%
mutate(Rank = paste0('#',row_number())) %>%
gt() %>%
tab_header(title = paste('Completed Air Yards Over Expected (CAYOE),', cayoe_filtered$season[1]),
subtitle = paste('Through week', my_week, 'MNF', '|', 'Min.', ifelse(round(summary(cayoe_filtered$pass_attempts)[4])>75,75,round(summary(cayoe_filtered$pass_attempts)[4]),'pass attempts > 0 air yards'))) %>%
cols_move_to_start(columns = vars(Rank)) %>%
cols_label(
games = 'GP',
passer = '',
posteam = '',
pass_attempts = 'Pass Attempts',
completions = 'Comp.',
yards = 'Yds',
td = 'TD',
# PPR_pts = 'FP',
exp_completions = 'xComp.',
exp_yards = 'xYds',
exp_td = 'xTD',
# exp_PPR_pts = 'xFP',
# ppr_pts_diff = "Pts Diff.",
sum_cayoe = "Total CAYOE",
cayoe_a = "Avg CAYOE"
) %>%
fmt_number(columns = vars(sum_cayoe, cayoe_a), decimals = 2) %>%
fmt_number(columns = vars(exp_td), decimals = 1) %>%
fmt_number(columns = vars(yards, exp_yards, exp_completions), decimals = 0, sep_mark = ',') %>%
tab_style(style = cell_text(size = 'x-large', weight = 'bold'), locations = cells_title(groups = 'title')) %>%
tab_style(style = cell_text(align = 'center', size = 'medium'), locations = cells_body()) %>%
tab_style(style = cell_text(align = 'left'), locations = cells_body(vars(passer))) %>%
tab_style(
style = cell_borders(
sides = "left",
color = color_cw[5],
weight = px(3)
),
locations = list(
cells_body(
columns = c(4,8,11,12)
)
)
) %>%
tab_style(
style = cell_text(weight = "bold"),
locations = cells_body(
columns = vars(Rank, passer)
)
) %>%
tab_spanner(label = 'Actual', columns = vars(completions, yards, td)) %>%
tab_spanner(label = 'Expected', columns = vars(exp_completions, exp_yards, exp_td)) %>%
tab_source_note(source_note = 'Data: @nflfastR') %>%
data_color(
columns = vars(sum_cayoe),
colors = scales::col_numeric(palette = c(color_cw[2], color_cw[6]), domain = c(max(cayoe_filtered$sum_cayoe), min(cayoe_filtered$sum_cayoe))),
autocolor_text = FALSE
) %>%
data_color(
columns = vars(cayoe_a),
colors = scales::col_numeric(palette = c(color_cw[2], color_cw[6]), domain = c(max(cayoe_filtered$cayoe_a), min(cayoe_filtered$cayoe_a))),
autocolor_text = FALSE
) %>%
text_transform(
locations = cells_body(vars(posteam)),
fn = function(x) web_image(url = paste0('https://a.espncdn.com/i/teamlogos/nfl/500/',x,'.png'))
) %>%
cols_width(vars(posteam) ~ px(45)) %>%
tab_options(
table.font.color = color_cw[5],
data_row.padding = '2px',
row_group.padding = '3px',
column_labels.border.bottom.color = color_cw[5],
column_labels.border.bottom.width = 1.4,
column_labels.font.weight = "bold",
table_body.border.top.color = color_cw[5],
row_group.border.top.width = 1.5,
row_group.border.top.color = '#999999',
table_body.border.bottom.width = 0.7,
table_body.border.bottom.color = '#999999',
row_group.border.bottom.width = 1,
row_group.border.bottom.color = color_cw[5],
table.border.top.color = 'transparent',
table.background.color = color_cw[1],
table.border.bottom.color = 'transparent',
row.striping.background_color = color_cw[2],
row.striping.include_table_body = TRUE
) %>%
opt_table_font(
font = list(
google_font("Chivo"),
default_fonts()
)
) %>%
gtsave(filename = paste0("xFP_QB_", cayoe_filtered$season[1], ".png"), path = "plots/desktop")
# xFP QB table
cayoe_filtered %>%
select(
games,
passer,
posteam,
pass_attempts,
completions,
yards,
td,
# PPR_pts,
exp_completions,
exp_yards,
exp_td,
# exp_PPR_pts,
# ppr_pts_diff,
sum_cayoe,
cayoe_a
) %>%
arrange(-cayoe_a) %>%
dplyr::slice(1:50) %>%
mutate(Rank = paste0('#',row_number())) %>%
gt() %>%
tab_header(title = paste('Completed Air Yards Over Expected (CAYOE),', cayoe_filtered$season[1]),
subtitle = paste('Through week', my_week, 'MNF', '|', 'Min.', ifelse(round(summary(cayoe_filtered$pass_attempts)[4])>75,75,round(summary(cayoe_filtered$pass_attempts)[4])),'pass attempts > 0 air yards')) %>%
cols_move_to_start(columns = vars(Rank)) %>%
cols_label(
games = 'GP',
passer = '',
posteam = '',
pass_attempts = 'Pass Attempts',
completions = 'Comp.',
yards = 'Yds',
td = 'TD',
# PPR_pts = 'FP',
exp_completions = 'xComp.',
exp_yards = 'xYds',
exp_td = 'xTD',
# exp_PPR_pts = 'xFP',
# ppr_pts_diff = "Pts Diff.",
sum_cayoe = "Total CAYOE",
cayoe_a = "Avg CAYOE"
) %>%
fmt_number(columns = vars(sum_cayoe, cayoe_a), decimals = 2) %>%
fmt_number(columns = vars(exp_td), decimals = 1) %>%
fmt_number(columns = vars(yards, exp_yards, exp_completions), decimals = 0, sep_mark = ',') %>%
tab_style(style = cell_text(size = 'x-large', weight = 'bold'), locations = cells_title(groups = 'title')) %>%
tab_style(style = cell_text(align = 'center', size = 'medium'), locations = cells_body()) %>%
tab_style(style = cell_text(align = 'left'), locations = cells_body(vars(passer))) %>%
tab_style(
style = cell_borders(
sides = "left",
color = color_cw[5],
weight = px(3)
),
locations = list(
cells_body(
columns = c(4,8,11,12)
)
)
) %>%
tab_style(
style = cell_text(weight = "bold"),
locations = cells_body(
columns = vars(Rank, passer)
)
) %>%
tab_spanner(label = 'Actual', columns = vars(completions, yards, td)) %>%
tab_spanner(label = 'Expected', columns = vars(exp_completions, exp_yards, exp_td)) %>%
tab_source_note(source_note = 'Data: @nflfastR') %>%
data_color(
columns = vars(sum_cayoe),
colors = scales::col_numeric(palette = c(color_cw[2], color_cw[6]), domain = c(max(cayoe_filtered$sum_cayoe), min(cayoe_filtered$sum_cayoe))),
autocolor_text = FALSE
) %>%
data_color(
columns = vars(cayoe_a),
colors = scales::col_numeric(palette = c(color_cw[2], color_cw[6]), domain = c(max(cayoe_filtered$cayoe_a), min(cayoe_filtered$cayoe_a))),
autocolor_text = FALSE
) %>%
text_transform(
locations = cells_body(vars(posteam)),
fn = function(x) web_image(url = paste0('https://a.espncdn.com/i/teamlogos/nfl/500/',x,'.png'))
) %>%
cols_width(vars(posteam) ~ px(45)) %>%
tab_options(
table.font.color = color_cw[5],
data_row.padding = '2px',
row_group.padding = '3px',
column_labels.border.bottom.color = color_cw[5],
column_labels.border.bottom.width = 1.4,
column_labels.font.weight = "bold",
table_body.border.top.color = color_cw[5],
row_group.border.top.width = 1.5,
row_group.border.top.color = '#999999',
table_body.border.bottom.width = 0.7,
table_body.border.bottom.color = '#999999',
row_group.border.bottom.width = 1,
row_group.border.bottom.color = color_cw[5],
table.border.top.color = 'transparent',
table.background.color = color_cw[1],
table.border.bottom.color = 'transparent',
row.striping.background_color = color_cw[2],
row.striping.include_table_body = TRUE
) %>%
opt_table_font(
font = list(
google_font("Chivo"),
default_fonts()
)
) %>%
gtsave(filename = paste0("xFP_QB_", cayoe_filtered$season[1], ".png"), path = "plots/desktop")
rm(list = ls())
